---
title: "Conteo Rápido"
author: "Equipo 1"
date: "12/8/2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(janitor)
library(kableExtra)
library(tidyverse)
library(extrafont)
library(scales)
library(showtext)
library(tint)
library(miniUI)
library(units)
library(ggfortify)
library(cowplot)
library(magrittr)
library("Cairo")

rm(list = ls())
`%notin%` = function(x,y) !(x %in% y)
source("funciones/muestra.R")
source("funciones/calculaECM.R")
source("funciones/graficaHistograma.R")
```

## Lectura de datos

```{r}
gobernador2015<- read_excel("data/ComputoGobernador2015_Casilla.xlsx", 
                            sheet = "POR CASILLA", skip = 1) %>%
  clean_names()

UbicacionCasillas2015 <- read_excel("data/UbicacionCasillas2015.xlsx", skip = 4) %>%
  clean_names()

casillas_sonora <- read.csv("data/casillas_sonora.csv")  %>%
  select(seccion, casilla_tipo) %>%
  distinct(seccion, casilla_tipo) %>%
  rbind(c(608, "RURAL"))
casillas_sonora$seccion %<>% as.numeric()
```

Se agrega lista nominal a la tabla de resultados por casilla

```{r}
gobernador2015 <- UbicacionCasillas2015 %>%
  left_join(gobernador2015, ., by = c("seccion", "casilla")) %>%
  select(-c(distrito_local.y, municipio.y, domicilio)) %>%
  mutate(seccion_casilla = paste(seccion, casilla)) %>%
  rename(municipio = municipio.x,
         distrito_local = distrito_local.x)
  
gobernador2015 <- casillas_sonora %>%
  left_join(gobernador2015, ., by = "seccion") %>%
  mutate(distrito_tipo = paste(distrito_local,casilla_tipo))
rm(casillas_sonora)
```

## Resultados globales

```{r}
gobernador2015 %>%
  summarise(PRI = sum(total_coalicion) / sum(votacion_total_emitida),
            PAN = sum(pan) / sum(votacion_total_emitida),
            PRD = sum(prd) / sum(votacion_total_emitida)) -> resultadoGlobal

# Resultado global
resultadoGlobal <- resultadoGlobal * 100
resultadoGlobal
```

```{r}
N <- length(gobernador2015$seccion_casilla)  # total de casillas
n <- muestra(N)                              # Número de secciones en la muestra
M <- 10                                    # Número de repeticiones
```

## Simulación: Muestreo aleatorio simple

```{r}
# Crea una matriz vacía
simulacionMAS <- matrix(rep(0, length(resultadoGlobal)*M), nrow = M)
colnames(simulacionMAS) <- c("PRI", "PAN", "PRD") 

t <- proc.time() # calcula tiempo: inicio 
for(i in 1:M){
  muestra <- sample(gobernador2015$seccion_casilla, n)
  gobernador2015 %>%
  filter(seccion_casilla %in% muestra) %>%
  summarise(PRI = sum(total_coalicion) / sum(votacion_total_emitida),
            PAN = sum(pan) / sum(votacion_total_emitida),
            PRD = sum(prd) / sum(votacion_total_emitida)) %>%
    as.numeric() -> simulacionMAS[i, ]
}
proc.time()-t  # calcula tiempo: final 
rm(muestra)

# Se convierte a data frame, se multiplica por 100 y se calcula error
simulacionMAS <- data.frame(simulacionMAS * 100) %>%
    mutate(dif.PRI = PRI - resultadoGlobal$PRI,
           dif.PAN = PAN - resultadoGlobal$PAN,
           dif.PRD = PRD - resultadoGlobal$PRD)
```

## Simulación: Muestreo sistematizado

```{r}
# Se calcula k, la posición de la casilla inicial se elige al azar entre 1 y k
k <- round(N/n,0)  # número de estratos

# Crea una matriz vacía
simulacionSIST <- matrix(rep(0, length(resultadoGlobal)*M), nrow = M)
colnames(simulacionSIST) <- c("PRI", "PAN", "PRD") 

t <- proc.time() # calcula tiempo: inicio 
for(i in 1:M){
  # Selección de posición de casilla inicial
  casilla0 <- sample(1:k, 1)

  # Seleccion de posición del resto de casillas
  posicion <- c()
  for(j in 1: n-1) {
    posicion <- c(posicion, casilla0 + j*k)
  }
  muestra <- gobernador2015$seccion_casilla[posicion]
  gobernador2015 %>%
  filter(seccion_casilla %in% muestra) %>%
  summarise(PRI = sum(total_coalicion) / sum(votacion_total_emitida),
            PAN = sum(pan) / sum(votacion_total_emitida),
            PRD = sum(prd) / sum(votacion_total_emitida)) %>%
    as.numeric() -> simulacionSIST[i, ]
}
proc.time()-t  # calcula tiempo: final 
rm(muestra)

# Se convierte a data frame, se multiplica por 100 y se calcula error
simulacionSIST <- data.frame(simulacionSIST * 100) %>%
    mutate(dif.PRI = PRI - resultadoGlobal$PRI,
           dif.PAN = PAN - resultadoGlobal$PAN,
           dif.PRD = PRD - resultadoGlobal$PRD)
```

## Simulación: Estratificado

Resumen de resultados por distrito

```{r, message = FALSE}
df.distritos <- gobernador2015 %>%
  group_by(distrito_local) %>%
  summarise(LN = sum(lista_nominal),
            N.dist = n(),           # Casillas por distrito
            p = LN/sum(gobernador2015$lista_nominal)) %>%   # Proporción
  mutate(n.dist = round(num.casillas = n * p)) %>%
  arrange(distrito_local)
```

```{r}
df.distritos
```


Sea:

- $L$ el número de estratos

- $\bar{y_i}$ la media muestral en el estrato $i$, $i= 1, \ldots, L$

- $n_i$ el tamaño de muestra

- $N_i$ el número de casillas. $N= N_1 + \ldots + N_L$

Estimador de la media poblacional $\mu$:

$$\bar{y}_{st} = \frac{1}{N} \sum_{i=1}^{L} N_i \bar{y_i}$$

Estimador de la varianza de $\bar{y}_{st}$:

$$\hat{V} (\bar{y}_{st}) = \frac{1}{N^2} \sum_{i=1}^{L} N_{i}^{2} 
\left(1- \frac{n_i}{N_i}\right) 
\left(\frac{s_i^2}{n_i}\right)$$

### Afijación simple

```{r, message = FALSE}
distritos <- df.distritos$distrito_local
L <- length(distritos)

casillas.xDistrito <- round(n / L)

# Crea una matriz vacía
simulacionESTR.simple <- matrix(rep(0, length(resultadoGlobal)*M), nrow = M)
colnames(simulacionESTR.simple) <- c("PRI", "PAN", "PRD") 

t <- proc.time() # calcula tiempo: inicio 
for(i in 1:M){
  # selección de una muestra
  muestra <- c() 
  for(j in 1: L){
    gobernador2015 %>%
    filter(distrito_local == distritos[j]) %>%
    select(seccion_casilla) -> df.muestra
    muestra <- c(muestra, sample(df.muestra$seccion_casilla, casillas.xDistrito))
  } 
  
  # Crea un data frame temporal con estimadores para cada estrato
  df.temporal <- gobernador2015 %>%
    filter(seccion_casilla %in% muestra) %>%
    group_by(distrito_local) %>% 
    summarise(PRI = sum(total_coalicion)/sum(votacion_total_emitida),
              PAN = sum(pan) / sum(votacion_total_emitida),
              PRD = sum(prd) / sum(votacion_total_emitida))
  
  simulacionESTR.simple[i, ] <- c(
    estPRI = df.distritos$N.dist %*% df.temporal$PRI / N,
    estPAN = df.distritos$N.dist %*% df.temporal$PAN / N,
    estPRD = df.distritos$N.dist %*% df.temporal$PRD / N)
}
proc.time()-t  # calcula tiempo: final 

rm(muestra, df.temporal, df.muestra)

# Se convierte a data frame, se multiplica por 100 y se calcula error
simulacionESTR.simple <- data.frame(simulacionESTR.simple * 100) %>%
    mutate(dif.PRI = PRI - resultadoGlobal$PRI,
           dif.PAN = PAN - resultadoGlobal$PAN,
           dif.PRD = PRD - resultadoGlobal$PRD)
```

### Afijación proporcional

```{r, message = FALSE}
# Crea una matriz vacía
simulacionESTR.prop <- matrix(rep(0, length(resultadoGlobal)*M), nrow = M)
colnames(simulacionESTR.prop) <- c("PRI", "PAN", "PRD") 

t <- proc.time() # calcula tiempo: inicio 
for(i in 1:M){
  
  # selección de una muestra
  muestra <- c() 
  for(j in 1: L){
    gobernador2015 %>%
    filter(distrito_local == distritos[j]) %>%
    select(seccion_casilla) -> df.muestra
    muestra <- c(muestra, sample(df.muestra$seccion_casilla, df.distritos$n.dist[j]))
  } 
  
  # Crea un data frame temporal con estimadores para cada estrato
  df.temporal <- gobernador2015 %>%
    filter(seccion_casilla %in% muestra) %>%
    group_by(distrito_local) %>% 
    summarise(PRI = sum(total_coalicion)/sum(votacion_total_emitida),
              PAN = sum(pan) / sum(votacion_total_emitida),
              PRD = sum(prd) / sum(votacion_total_emitida)) 

  # Agrega información de distritos; específicamente, el número de casillas
  df.temporal <- df.distritos %>%
    left_join(df.temporal) %>%
    summarise(estPRI = N.dist %*% PRI / N,
              estPAN = N.dist %*% PAN / N,
              estPRD = N.dist %*% PRD / N) %>%
    as.numeric() -> simulacionESTR.prop[i, ]
}
proc.time()-t  # calcula tiempo: final 

rm(muestra, df.temporal, df.muestra)

# Se convierte a data frame, se multiplica por 100 y se calcula error
simulacionESTR.prop <- data.frame(simulacionESTR.prop * 100) %>%
    mutate(dif.PRI = PRI - resultadoGlobal$PRI,
           dif.PAN = PAN - resultadoGlobal$PAN,
           dif.PRD = PRD - resultadoGlobal$PRD)
```

### Tabla por distrito y casilla

```{r, message = FALSE}
rm(df.distritos)
df.distritos<- gobernador2015 %>%
  group_by(distrito_tipo) %>%
  summarise(LN = sum(lista_nominal),
            N.dist = n(),     # Casillas por distrito
            p = LN/sum(gobernador2015$lista_nominal)) %>%   # Proporción
  mutate(n.dist = round(num.casillas = n * p)) %>%
  arrange(distrito_tipo)
```

```{r}
df.distritos
```

### Por distrito y tipo de casilla

```{r, message = FALSE}
distritos <- df.distritos$distrito_tipo
L <- length(distritos)
# Crea una matriz vacía
simulacionESTR02 <- matrix(rep(0, length(resultadoGlobal)*M), nrow = M)
colnames(simulacionESTR02) <- c("PRI", "PAN", "PRD") 

t <- proc.time() # calcula tiempo: inicio 
for(i in 1:M){
  # selección de una muestra
  muestra <- c() 
  for(j in 1: L){
    gobernador2015 %>%
    filter(distrito_tipo == distritos[j]) %>%
    select(seccion_casilla) -> df.muestra
    muestra <- c(muestra, sample(df.muestra$seccion_casilla, df.distritos$n.dist[j]))
  } 
  
  # Crea un data frame temporal con estimadores para cada estrato
  df.temporal <- gobernador2015 %>%
    filter(seccion_casilla %in% muestra) %>%
    group_by(distrito_tipo) %>% 
    summarise(PRI = sum(total_coalicion)/sum(votacion_total_emitida),
              PAN = sum(pan) / sum(votacion_total_emitida),
              PRD = sum(prd) / sum(votacion_total_emitida)) 

  # Agrega número de casillas
  df.temporal <- df.distritos %>%
    left_join(df.temporal) %>%
    summarise(estPRI = N.dist %*% PRI / N,
              estPAN = N.dist %*% PAN / N,
              estPRD = N.dist %*% PRD / N) %>%
    as.numeric() -> simulacionESTR02[i, ]
}
proc.time()-t  # calcula tiempo: final 

rm(muestra, df.temporal, df.muestra)

# Se convierte a data frame, se multiplica por 100 y se calcula error
simulacionESTR02 <- data.frame(simulacionESTR02 * 100) %>%
    mutate(dif.PRI = PRI - resultadoGlobal$PRI,
           dif.PAN = PAN - resultadoGlobal$PAN,
           dif.PRD = PRD - resultadoGlobal$PRD)
```



## Cálculo de error cuadrático medio

```{r}
options(scipen=999)
resumen <- data.frame()
resumen <- resumen %>%
  rbind(calculaECM(simulacionMAS)) %>%
  rbind(calculaECM(simulacionSIST)) %>%
  rbind(calculaECM(simulacionESTR.simple)) %>%
  rbind(calculaECM(simulacionESTR.prop)) %>%
  rbind(calculaECM(simulacionESTR02))

row.names(resumen) = c("MAS", "Sistemático", "Estr simple", "Estr prop", "Estr distrito y casilla")
resumen
```

## Resumen de error de estimación

```{r, eval=FALSE}
summary(simulacionMAS[4:6])
summary(simulacionSIST[4:6])
summary(simulacionESTR.simple[4:6])
summary(simulacionESTR.prop[4:6])
summary(simulacionESTR02[4:6])
```

### Gráficas

```{r, echo=FALSE}
source("funciones/graficaHistograma.R")
  Tema <- theme(plot.title = (element_text(size = 20, color = "black")),
                plot.subtitle = (element_text(size = 10, color = "black")),
                legend.position = "top",  plot.margin = margin(0.5, 1, 0.5, 1, "cm"),
                legend.key.height = unit (0.2, "cm"), legend.key.width = unit (0.2, "cm"),
                axis.text = element_text(size = 10, color = "black"),
                legend.text = element_text(size = 8, color = "black"),
                legend.title = element_text(size = 10, color = "black"),
                plot.caption = element_text(size = 10, color = "black", face="italic"),
                axis.title = element_text(size = 12, color = "black"))
```

Muestreo aleatorio simple.
```{r}
titulo <- "Simulación: Muestreo aleatorio simple"
graficaHistograma(simulacionMAS, titulo)
```

Estratificado.

```{r}
titulo <- "Simulación: Muestreo estratificado"
graficaHistograma(simulacionESTR.simple, titulo)
```

Estratificado Rural/Urbano
```{r}
titulo <- "Simulación: Muestreo estratificado R/U"
graficaHistograma(simulacionESTR02, titulo)
```

Error: Muestreo aleatorio simple
```{r}
maserror <- ggplot(data=simulacionMAS, aes(x=dif.PRI^2)) +
  geom_histogram(bins=50, color="red", fill = "red", alpha=0.5)+
  scale_y_continuous(labels = comma) +
  theme_bw() + Tema +
  labs(fill = "Partido", color= NULL, y = "Observaciones", x = "Diferencia al cuadrado", title = "Simulación: Muestreo aleatorio simple",
       caption = NULL, subtitle = "Errores de mil simulaciones respecto al resultado observado")
show(maserror)
```
Error: Estratificado
```{r}
estrerror <- ggplot(data=simulacionESTR.simple, aes(x=dif.PRI^2)) +
  geom_histogram(bins=50, color="red", fill = "red", alpha=0.5)+
  scale_y_continuous(labels = comma) +
  theme_bw() + Tema +
  labs(fill = "Partido", color= NULL, y = "Observaciones", x = "Diferencia al cuadrado", title = "Simulación: Muestreo estratificado",
       caption = NULL, subtitle = "Errores de mil simulaciones respecto al resultado observado")
show(estrerror)
```
Error: Estratificado R/U
```{r}
estrerrorprop <- ggplot(data=simulacionESTR.prop, aes(x=dif.PRI^2)) +
  geom_histogram(bins=50, color="red", fill = "red", alpha=0.5)+
  scale_y_continuous(labels = comma) +
  theme_bw() + Tema +
  labs(fill = "Partido", color= NULL, y = "Observaciones", x = "Diferencia al cuadrado", title = "Simulación: Muestreo estratificado Rural/Urbano",
       caption = NULL, subtitle = "Errores de mil simulaciones respecto al resultado observado")
show(estrerror)
```
Cálculo intervalos
```{r}
resumen <- resumen %>% tibble::rownames_to_column()  %>% rename(muestreo=rowname)
resumen2 <- data.frame(t(resumen[-1]))
colnames(resumen2) <- resumen[, 1]

intervaloMAS <- simulacionMAS %>% summarise(PRI= mean(PRI), PAN=mean(PAN), PRD=mean(PRD)) %>%
  gather("Partido", "Promedio") %>% mutate(Máximo=Promedio+(3*(sqrt(as.double(resumen2$MAS)))), Mínimo=Promedio-(3*(sqrt(as.double(resumen2$MAS))))) %>%
  filter(Partido!="PRD")
intervaloestr <- simulacionESTR.simple %>% summarise(PRI= mean(PRI), PAN=mean(PAN), PRD=mean(PRD))%>%
  gather("Partido", "Promedio") %>%  mutate(Máximo=Promedio+(3*sqrt(as.double(resumen2$Sistemático))), Mínimo=Promedio-(3*sqrt(as.double(resumen2$Sistemático)))) %>%
  filter(Partido!="PRD")
intervaloestrprop <- simulacionESTR.prop %>% summarise(PRI= mean(PRI), PAN=mean(PAN), PRD=mean(PRD))%>%
  gather("Partido", "Promedio") %>%  mutate(Máximo=Promedio+(3*sqrt(as.double(resumen2$Sistemático))), Mínimo=Promedio-(3*sqrt(as.double(resumen2$Sistemático)))) %>%
  filter(Partido!="PRD")
```

Intervalo Muestra Aleatoria Simple
```{r}
intervalMAS <- ggplot(data=intervaloMAS, aes(y=Partido)) +
  geom_point(aes(x=Promedio),color="red",fill="red",  alpha=0.5)+
  geom_point(aes(x=Mínimo),color="blue", fill="blue", alpha=0.5)+
  geom_point(aes(x=Máximo),color="blue", fill="blue",  alpha=0.5)+
  theme_bw() + Tema +
  labs(fill = NULL, color= NULL, y = "% votación", x = "Partido", title = "Simulación: Muestreo aleatorio simple",
       caption = NULL, subtitle = "Intervalo de confianza")
show(intervalMAS)
```
Intervalo Estratificado
```{r}
intervalestr <- ggplot(data=intervaloestr, aes(y=Partido)) +
  geom_point(aes(x=Promedio),color="red",fill="red",  alpha=0.5)+
  geom_point(aes(x=Mínimo),color="blue", fill="blue", alpha=0.5)+
  geom_point(aes(x=Máximo),color="blue", fill="blue",  alpha=0.5)+
  theme_bw() + Tema +
  labs(fill = NULL, color= NULL, y = "% votación", x = "Partido", title = "Simulación: Muestreo estratificado",
       caption = NULL, subtitle = "Intervalo de confianza")
show(intervalestr)
```
Intervalo Estratificado R/U
```{r}
intervalestrprop <- ggplot(data=intervaloestrprop, aes(y=Partido)) +
  geom_point(aes(x=Promedio),color="red",fill="red",  alpha=0.5)+
  geom_point(aes(x=Mínimo),color="blue", fill="blue", alpha=0.5)+
  geom_point(aes(x=Máximo),color="blue", fill="blue",  alpha=0.5)+
  theme_bw() + Tema +
  labs(fill = NULL, color= NULL, y = "% votación", x = "Partido", title = "Simulación: Muestreo estratificado R/U",
       caption = NULL, subtitle = "Intervalo de confianza")
show(intervalestrprop)
```



